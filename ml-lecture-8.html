<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CNN vs ANN: Interactive Architecture Analysis</title>
<style>
  :root {
    /* Colors from your presentation template */
    --bg-primary: #FEF7ED;
    --text-primary: #1E293B;
    --accent-orange: #EA580C;
    --accent-teal: #059669;
    --gradient-primary: linear-gradient(135deg, #EA580C, #059669);
    --gradient-reverse: linear-gradient(135deg, #059669, #EA580C);
    
    /* Semantic color assignments */
    --ann-primary: #EA580C;
    --ann-secondary: rgba(234, 88, 12, 0.1);
    --cnn-primary: #059669;
    --cnn-secondary: rgba(5, 150, 105, 0.1);
    --interactive: var(--gradient-primary);
    --highlight: var(--accent-orange);
  }
  
  * { 
    margin: 0; 
    padding: 0; 
    box-sizing: border-box; 
  }
  
  html, body { 
    height: 100%; 
    font-family: Georgia, serif;
  }
  
  body {
    background: var(--bg-primary);
    color: var(--text-primary);
    line-height: 1.6;
    overflow-x: hidden;
  }
  
  /* Header */
  header {
    background: var(--gradient-primary);
    padding: 40px 20px;
    text-align: center;
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    border-bottom: 5px solid var(--accent-orange);
  }
  
  header h1 {
    font-size: 3.5em;
    font-weight: bold;
    color: var(--bg-primary);
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    margin-bottom: 20px;
    letter-spacing: -0.02em;
  }
  
  header .subtitle {
    font-size: 1.6em;
    color: rgba(254, 247, 237, 0.9);
    font-style: italic;
    font-weight: 400;
  }
  
  /* Main Layout */
  .container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 40px 20px;
  }
  
  .main-grid {
    display: grid;
    grid-template-columns: 400px 1fr;
    gap: 40px;
    margin-bottom: 40px;
  }
  
  @media (max-width: 1200px) {
    .main-grid { grid-template-columns: 1fr; }
    header h1 { font-size: 2.8em; }
    header .subtitle { font-size: 1.3em; }
  }
  
  /* Panel Base Styles */
  .panel {
    background: var(--bg-primary);
    border: 2px solid var(--accent-orange);
    border-radius: 20px;
    padding: 30px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    border-left: 5px solid var(--accent-orange);
  }
  
  /* Interactive Controls Panel */
  .controls-panel {
    position: sticky;
    top: 20px;
    height: fit-content;
  }
  
  .controls-title {
    font-size: 2.2em;
    font-weight: bold;
    color: var(--text-primary);
    margin-bottom: 30px;
    text-align: center;
    padding-bottom: 10px;
    border-bottom: 3px solid var(--accent-orange);
  }
  
  .drawing-area {
    background: rgba(5, 150, 105, 0.05);
    border: 2px solid var(--accent-teal);
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 30px;
  }
  
  .canvas-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
  }
  
  @media (max-width: 800px) {
    .canvas-row { grid-template-columns: 1fr; }
  }
  
  .canvas-container {
    text-align: center;
  }
  
  .canvas-label {
    font-size: 1.1em;
    color: var(--text-primary);
    margin-bottom: 15px;
    font-weight: 600;
  }
  
  #draw {
    border: 3px solid var(--accent-orange);
    border-radius: 15px;
    background: #000;
    cursor: crosshair;
    transition: all 0.3s ease;
  }
  
  #draw:hover {
    box-shadow: 0 10px 30px rgba(234, 88, 12, 0.3);
    transform: translateY(-2px);
  }
  
  #mini {
    border: 3px solid var(--accent-teal);
    border-radius: 15px;
    background: #111;
    image-rendering: pixelated;
    transition: all 0.3s ease;
  }
  
  #mini:hover {
    box-shadow: 0 10px 30px rgba(5, 150, 105, 0.3);
    transform: translateY(-2px);
  }
  
  /* Buttons */
  .btn-group {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    justify-content: center;
    margin: 20px 0;
  }
  
  .btn {
    background: var(--gradient-primary);
    color: var(--bg-primary);
    border: none;
    padding: 12px 24px;
    border-radius: 25px;
    font-family: Georgia, serif;
    font-weight: 600;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(234, 88, 12, 0.2);
  }
  
  .btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 25px rgba(234, 88, 12, 0.3);
  }
  
  .btn:active {
    transform: translateY(-1px);
  }
  
  .btn.secondary {
    background: rgba(30, 41, 59, 0.1);
    color: var(--text-primary);
    border: 2px solid var(--text-primary);
  }
  
  .btn.secondary:hover {
    background: var(--text-primary);
    color: var(--bg-primary);
  }
  
  .btn.danger {
    background: linear-gradient(135deg, #dc2626, #ef4444);
  }
  
  .digit-btn {
    background: var(--bg-primary);
    color: var(--text-primary);
    border: 2px solid var(--accent-orange);
    min-width: 45px;
    padding: 10px;
    font-size: 1.1rem;
    font-weight: bold;
    font-family: Georgia, serif;
  }
  
  .digit-btn:hover {
    background: var(--accent-orange);
    color: var(--bg-primary);
  }
  
  /* Architecture Comparison */
  .architecture-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 40px;
  }
  
  @media (max-width: 900px) {
    .architecture-grid { grid-template-columns: 1fr; }
  }
  
  .network-panel {
    border-radius: 20px;
    padding: 30px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    position: relative;
    overflow: hidden;
    border-left: 5px solid;
  }
  
  .ann-panel {
    background: var(--bg-primary);
    border: 2px solid var(--ann-primary);
    border-left-color: var(--ann-primary);
  }
  
  .cnn-panel {
    background: var(--bg-primary);
    border: 2px solid var(--cnn-primary);
    border-left-color: var(--cnn-primary);
  }
  
  .network-title {
    font-size: 2.2em;
    font-weight: bold;
    margin-bottom: 20px;
    text-align: center;
    padding: 20px;
    border-radius: 15px;
    color: var(--bg-primary);
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    margin-bottom: 30px;
  }
  
  .ann-title {
    background: linear-gradient(135deg, var(--ann-primary), #f97316);
  }
  
  .cnn-title {
    background: linear-gradient(135deg, var(--cnn-primary), #10b981);
  }
  
  .architecture-flow {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 25px;
    margin: 30px 0;
  }
  
  .layer-box {
    background: var(--bg-primary);
    border: 2px solid;
    border-radius: 15px;
    padding: 25px;
    text-align: center;
    min-width: 250px;
    width: 100%;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  }
  
  .layer-box:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 30px rgba(0,0,0,0.2);
  }
  
  .ann-layer {
    border-color: var(--ann-primary);
    background: linear-gradient(135deg, var(--bg-primary), var(--ann-secondary));
  }
  
  .cnn-layer {
    border-color: var(--cnn-primary);
    background: linear-gradient(135deg, var(--bg-primary), var(--cnn-secondary));
  }
  
  .layer-title {
    font-size: 1.4em;
    font-weight: bold;
    margin-bottom: 10px;
    color: var(--text-primary);
  }
  
  .layer-details {
    font-size: 1rem;
    color: rgba(30, 41, 59, 0.7);
    margin-bottom: 15px;
    font-style: italic;
  }
  
  .layer-visual {
    height: 80px;
    background: rgba(30, 41, 59, 0.05);
    border: 1px solid rgba(30, 41, 59, 0.2);
    border-radius: 10px;
    margin: 15px 0;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    overflow: hidden;
  }
  
  .flow-arrow {
    font-size: 2.5rem;
    color: var(--accent-orange);
    text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    font-weight: bold;
  }
  
  /* Mathematical Analysis */
  .math-section {
    background: linear-gradient(135deg, rgba(234, 88, 12, 0.05), rgba(5, 150, 105, 0.05));
    border: 2px solid var(--accent-orange);
    border-radius: 15px;
    padding: 25px;
    margin: 25px 0;
    border-left: 5px solid var(--accent-orange);
  }
  
  .math-title {
    color: var(--accent-orange);
    font-size: 1.6em;
    font-weight: bold;
    margin-bottom: 15px;
    text-align: center;
  }
  
  .formula {
    background: var(--text-primary);
    color: var(--bg-primary);
    padding: 20px;
    border-radius: 10px;
    font-family: 'Courier New', monospace;
    font-size: 1.1rem;
    margin: 15px 0;
    overflow-x: auto;
    line-height: 1.8;
    box-shadow: 0 4px 15px rgba(30, 41, 59, 0.2);
  }
  
  /* Interactive Convolution Demo */
  .conv-demo {
    background: var(--bg-primary);
    border: 2px solid var(--accent-teal);
    border-radius: 20px;
    padding: 30px;
    margin: 30px 0;
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    border-left: 5px solid var(--accent-teal);
  }
  
  .matrix-demo {
    display: grid;
    grid-template-columns: 1fr auto 1fr auto 1fr;
    gap: 25px;
    align-items: center;
    margin: 30px 0;
  }
  
  @media (max-width: 900px) {
    .matrix-demo { 
      grid-template-columns: 1fr; 
      gap: 20px; 
      text-align: center;
    }
  }
  
  .matrix {
    display: grid;
    gap: 4px;
    justify-content: center;
  }
  
  .matrix-5x5 { grid-template-columns: repeat(5, 40px); }
  .matrix-3x3 { grid-template-columns: repeat(3, 40px); }
  
  .matrix-cell {
    width: 40px;
    height: 40px;
    border: 2px solid var(--text-primary);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 1rem;
    border-radius: 8px;
    transition: all 0.3s ease;
    font-family: Georgia, serif;
  }
  
  .input-cell {
    background: linear-gradient(135deg, var(--cnn-primary), #10b981);
    color: var(--bg-primary);
    border-color: var(--cnn-primary);
  }
  
  .kernel-cell {
    background: linear-gradient(135deg, var(--ann-primary), #f97316);
    color: var(--bg-primary);
    border-color: var(--ann-primary);
  }
  
  .output-cell {
    background: var(--gradient-primary);
    color: var(--bg-primary);
    border-color: var(--accent-orange);
  }
  
  .highlighted {
    transform: scale(1.15);
    box-shadow: 0 0 25px rgba(234, 88, 12, 0.6);
    z-index: 10;
    position: relative;
  }
  
  .conv-arrow {
    font-size: 3rem;
    color: var(--accent-orange);
    font-weight: bold;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
  }
  
  /* Metrics Display */
  .metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin: 30px 0;
  }
  
  .metric-card {
    background: var(--gradient-primary);
    color: var(--bg-primary);
    border-radius: 20px;
    padding: 30px 25px;
    text-align: center;
    transition: all 0.3s ease;
    box-shadow: 0 10px 30px rgba(234, 88, 12, 0.2);
  }
  
  .metric-card:hover {
    transform: translateY(-10px);
    box-shadow: 0 15px 40px rgba(234, 88, 12, 0.3);
  }
  
  .metric-label {
    font-size: 1rem;
    margin-bottom: 10px;
    font-weight: 600;
    opacity: 0.9;
  }
  
  .metric-value {
    font-size: 2.5em;
    font-weight: bold;
    line-height: 1;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
  }
  
  /* Progress Bars */
  .progress-container {
    margin: 20px 0;
  }
  
  .progress-label {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    font-size: 1rem;
    font-weight: 600;
  }
  
  .progress-bar {
    height: 12px;
    background: rgba(30, 41, 59, 0.1);
    border-radius: 6px;
    overflow: hidden;
    border: 1px solid rgba(30, 41, 59, 0.2);
  }
  
  .progress-fill {
    height: 100%;
    background: var(--gradient-primary);
    transition: width 0.5s ease;
    border-radius: 5px;
  }
  
  .progress-ann .progress-fill {
    background: linear-gradient(90deg, var(--ann-primary), #f97316);
  }
  
  .progress-cnn .progress-fill {
    background: linear-gradient(90deg, var(--cnn-primary), #10b981);
  }
  
  /* Tabs */
  .tab-container {
    margin: 40px 0;
  }
  
  .tabs {
    display: flex;
    gap: 8px;
    margin-bottom: 25px;
    flex-wrap: wrap;
    justify-content: center;
  }
  
  .tab {
    background: var(--bg-primary);
    color: var(--text-primary);
    border: 2px solid var(--accent-orange);
    padding: 15px 25px;
    border-radius: 25px;
    cursor: pointer;
    font-weight: 600;
    font-family: Georgia, serif;
    transition: all 0.3s ease;
    font-size: 1rem;
  }
  
  .tab.active {
    background: var(--gradient-primary);
    color: var(--bg-primary);
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(234, 88, 12, 0.3);
  }
  
  .tab:hover:not(.active) {
    background: rgba(234, 88, 12, 0.1);
    transform: translateY(-2px);
  }
  
  .tab-content {
    display: none;
    background: var(--bg-primary);
    border: 2px solid var(--accent-teal);
    border-radius: 20px;
    padding: 40px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    border-left: 5px solid var(--accent-teal);
  }
  
  .tab-content.active {
    display: block;
  }
  
  /* Step Controls */
  .step-controls {
    display: flex;
    gap: 15px;
    justify-content: center;
    align-items: center;
    margin: 25px 0;
  }
  
  .step-display {
    background: var(--text-primary);
    color: var(--bg-primary);
    border: 2px solid var(--accent-orange);
    border-radius: 15px;
    padding: 20px;
    margin: 20px 0;
    font-family: 'Courier New', monospace;
    font-size: 1rem;
    line-height: 1.6;
    box-shadow: 0 4px 15px rgba(30, 41, 59, 0.2);
  }
  
  /* Input Controls */
  .input-controls {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin: 25px 0;
  }
  
  .control-group {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  .control-label {
    font-size: 1rem;
    color: var(--text-primary);
    font-weight: 600;
    min-width: 60px;
  }
  
  input[type="range"] {
    flex: 1;
    height: 8px;
    background: rgba(30, 41, 59, 0.1);
    border-radius: 4px;
    outline: none;
    border: 1px solid rgba(30, 41, 59, 0.2);
  }
  
  input[type="range"]::-webkit-slider-thumb {
    appearance: none;
    width: 24px;
    height: 24px;
    background: var(--gradient-primary);
    border-radius: 50%;
    cursor: pointer;
    box-shadow: 0 2px 6px rgba(234, 88, 12, 0.3);
  }
  
  input[type="checkbox"] {
    width: 20px;
    height: 20px;
    accent-color: var(--accent-orange);
  }
  
  /* Feature Maps Visualization */
  .feature-maps {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 20px;
    margin: 30px 0;
  }
  
  .feature-card {
    background: var(--bg-primary);
    border: 2px solid var(--accent-teal);
    border-radius: 15px;
    padding: 20px;
    text-align: center;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  }
  
  .feature-card:hover {
    border-color: var(--accent-orange);
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(234, 88, 12, 0.2);
  }
  
  .feature-title {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 15px;
  }
  
  .feature-canvas {
    border: 1px solid rgba(30, 41, 59, 0.2);
    border-radius: 10px;
    width: 100%;
    height: auto;
    image-rendering: pixelated;
  }
  
  /* Highlight Boxes */
  .highlight-box {
    background: var(--accent-teal);
    color: var(--bg-primary);
    padding: 20px;
    border-radius: 15px;
    margin: 20px 0;
    font-weight: bold;
    box-shadow: 0 4px 15px rgba(5, 150, 105, 0.2);
  }
  
  .accent-box {
    background: var(--accent-orange);
    color: var(--bg-primary);
    padding: 20px;
    border-radius: 15px;
    margin: 20px 0;
    font-style: italic;
    font-weight: 600;
    box-shadow: 0 4px 15px rgba(234, 88, 12, 0.2);
  }
  
  .emphasis {
    background: var(--accent-orange);
    color: var(--bg-primary);
    padding: 6px 12px;
    border-radius: 8px;
    font-weight: bold;
    display: inline-block;
    box-shadow: 0 2px 6px rgba(234, 88, 12, 0.2);
  }
  
  /* Responsive Design */
  @media (max-width: 768px) {
    .container { padding: 20px 10px; }
    .main-grid { grid-template-columns: 1fr; gap: 25px; }
    .canvas-row { grid-template-columns: 1fr; }
    .matrix-demo { grid-template-columns: 1fr; gap: 15px; }
    .architecture-grid { grid-template-columns: 1fr; }
    .input-controls { grid-template-columns: 1fr; }
    .tabs { justify-content: flex-start; }
    .tab { padding: 12px 20px; font-size: 0.9rem; }
  }
  
  /* Utility Classes */
  .text-center { text-align: center; }
  .text-ann { color: var(--ann-primary); }
  .text-cnn { color: var(--cnn-primary); }
  .text-highlight { color: var(--accent-orange); }
  .font-bold { font-weight: bold; }
  .mb-20 { margin-bottom: 20px; }
  .mt-20 { margin-top: 20px; }
  
  /* Animation */
  .float {
    animation: float 3s ease-in-out infinite;
  }
  
  @keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
  }
</style>
</head>
<body>
  <header>
    <h1 class="float">CNN vs ANN: Interactive Architecture Analysis</h1>
    <div class="subtitle">Draw digits → Watch real-time processing → Understand mathematical foundations</div>
  </header>

  <div class="container">
    <div class="main-grid">
      <!-- Interactive Controls -->
      <div class="panel controls-panel">
        <h2 class="controls-title">🎨 Interactive Input</h2>
        
        <div class="drawing-area">
          <div class="canvas-row">
            <div class="canvas-container">
              <div class="canvas-label">Draw Here (224×224)</div>
              <canvas id="draw" width="224" height="224" style="width:180px;height:180px;"></canvas>
              <div class="text-highlight" style="font-size:0.9rem; margin-top:8px; font-weight:600;">
                Brush: <span id="brushSizeLabel">18</span>px
              </div>
            </div>
            <div class="canvas-container">
              <div class="canvas-label">Processed (28×28)</div>
              <canvas id="mini" width="28" height="28" style="width:180px;height:180px;"></canvas>
            </div>
          </div>
          
          <div class="btn-group">
            <button class="btn danger" id="clearBtn">Clear</button>
            <button class="btn secondary" id="undoBtn">Undo</button>
            <button class="btn secondary" id="invertBtn">Invert</button>
            <button class="btn" id="processBtn">Process</button>
          </div>
          
          <div class="input-controls">
            <div class="control-group">
              <span class="control-label">Brush:</span>
              <input type="range" min="6" max="36" value="18" id="brushRange" />
            </div>
            <div class="control-group">
              <span class="control-label">Eraser:</span>
              <input type="checkbox" id="eraserToggle" />
            </div>
          </div>
          
          <div class="btn-group">
            <button class="btn secondary" id="shiftRight">Shift →</button>
            <button class="btn secondary" id="shiftDown">Shift ↓</button>
          </div>
          
          <div style="text-align:center; margin:20px 0;">
            <div class="control-label mb-20">Quick Digits:</div>
            <div class="btn-group">
              <button class="digit-btn" data-digit="0">0</button>
              <button class="digit-btn" data-digit="1">1</button>
              <button class="digit-btn" data-digit="2">2</button>
              <button class="digit-btn" data-digit="3">3</button>
              <button class="digit-btn" data-digit="4">4</button>
              <button class="digit-btn" data-digit="5">5</button>
              <button class="digit-btn" data-digit="6">6</button>
              <button class="digit-btn" data-digit="7">7</button>
              <button class="digit-btn" data-digit="8">8</button>
              <button class="digit-btn" data-digit="9">9</button>
            </div>
          </div>
        </div>
        
        <div class="metrics-grid">
          <div class="metric-card">
            <div class="metric-label">ANN Parameters</div>
            <div class="metric-value" id="annParams">–</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">CNN Parameters</div>
            <div class="metric-value" id="cnnParams">–</div>
          </div>
        </div>
        
        <div class="progress-container">
          <div class="progress-label">
            <span class="font-bold">Translation Stability Comparison</span>
          </div>
          <div class="progress-container progress-ann">
            <div class="progress-label">
              <span class="text-ann font-bold">ANN</span>
              <span id="annStabVal">–</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" id="annStab"></div>
            </div>
          </div>
          <div class="progress-container progress-cnn">
            <div class="progress-label">
              <span class="text-cnn font-bold">CNN</span>
              <span id="cnnStabVal">–</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" id="cnnStab"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Architecture Comparison -->
      <div class="architecture-grid">
        <!-- ANN Panel -->
        <div class="network-panel ann-panel">
          <h2 class="network-title ann-title">🧠 Artificial Neural Network</h2>
          
          <div class="architecture-flow">
            <div class="layer-box ann-layer">
              <div class="layer-title text-ann">Input Layer (Flatten)</div>
              <div class="layer-details">28×28 = 784 neurons</div>
              <div class="layer-visual">
                <canvas id="annInput" width="80" height="40" style="width:100%;height:100%;"></canvas>
              </div>
            </div>
            
            <div class="flow-arrow">↓</div>
            
            <div class="layer-box ann-layer">
              <div class="layer-title text-ann">Hidden Layer</div>
              <div class="layer-details">64 fully connected neurons</div>
              <div class="layer-visual">
                <canvas id="annHidden" width="160" height="40" style="width:100%;height:100%;"></canvas>
              </div>
            </div>
            
            <div class="flow-arrow">↓</div>
            
            <div class="layer-box ann-layer">
              <div class="layer-title text-ann">Output Layer</div>
              <div class="layer-details">10 neurons (digits 0-9)</div>
              <div class="layer-visual">
                <canvas id="annLogits" width="160" height="40" style="width:100%;height:100%;"></canvas>
              </div>
            </div>
          </div>
          
          <div class="math-section">
            <div class="math-title">ANN Mathematics</div>
            <div class="formula">
              h = ReLU(W₁x + b₁)<br>
              y = W₂h + b₂<br>
              <span class="emphasis">Parameters: 784×64 + 64×10 = 50,890</span>
            </div>
          </div>
        </div>

        <!-- CNN Panel -->
        <div class="network-panel cnn-panel">
          <h2 class="network-title cnn-title">🔍 Convolutional Neural Network</h2>
          
          <div class="architecture-flow">
            <div class="layer-box cnn-layer">
              <div class="layer-title text-cnn">Conv1 (3×3, 8 filters)</div>
              <div class="layer-details">28×28×8 feature maps</div>
              <div class="layer-visual">
                <canvas id="conv1Grid" width="160" height="40" style="width:100%;height:100%;"></canvas>
              </div>
            </div>
            
            <div class="flow-arrow">↓</div>
            
            <div class="layer-box cnn-layer">
              <div class="layer-title text-cnn">MaxPool (2×2)</div>
              <div class="layer-details">14×14×8 feature maps</div>
              <div class="layer-visual">
                <canvas id="pool1Grid" width="160" height="40" style="width:100%;height:100%;"></canvas>
              </div>
            </div>
            
            <div class="flow-arrow">↓</div>
            
            <div class="layer-box cnn-layer">
              <div class="layer-title text-cnn">Conv2 (3×3, 16 filters)</div>
              <div class="layer-details">14×14×16 feature maps</div>
              <div class="layer-visual">
                <canvas id="conv2Grid" width="160" height="40" style="width:100%;height:100%;"></canvas>
              </div>
            </div>
            
            <div class="flow-arrow">↓</div>
            
            <div class="layer-box cnn-layer">
              <div class="layer-title text-cnn">MaxPool (2×2)</div>
              <div class="layer-details">7×7×16 feature maps</div>
              <div class="layer-visual">
                <canvas id="pool2Grid" width="160" height="40" style="width:100%;height:100%;"></canvas>
              </div>
            </div>
            
            <div class="flow-arrow">↓</div>
            
            <div class="layer-box cnn-layer">
              <div class="layer-title text-cnn">Dense Output</div>
              <div class="layer-details">10 neurons (digits 0-9)</div>
              <div class="layer-visual">
                <canvas id="cnnLogits" width="160" height="40" style="width:100%;height:100%;"></canvas>
              </div>
            </div>
          </div>
          
          <div class="math-section">
            <div class="math-title">CNN Mathematics</div>
            <div class="formula">
              Output[i,j] = Σ Input[i+m,j+n] × Kernel[m,n]<br>
              Size = (Input - Kernel + 2×Pad) / Stride + 1<br>
              <span class="emphasis">Parameters: 3×3×8 + 3×3×8×16 + 784×10 = 9,098</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Interactive Mathematical Analysis -->
    <div class="tab-container">
      <div class="tabs">
        <button class="tab active" data-section="convolution">🔄 Interactive Convolution</button>
        <button class="tab" data-section="features">🎯 Feature Analysis</button>
        <button class="tab" data-section="comparison">📊 Deep Comparison</button>
      </div>

      <!-- Convolution Tab -->
      <div class="tab-content active" id="convolution">
        <div class="conv-demo">
          <h3 class="text-center text-highlight mb-20" style="font-size: 2.2em; margin-bottom: 30px; font-weight: bold;">Step-by-Step Convolution Operation</h3>
          
          <div class="matrix-demo">
            <div class="text-center">
              <h4 class="text-cnn" style="font-size: 1.4em; margin-bottom: 15px;">Input (5×5)</h4>
              <div class="matrix matrix-5x5" id="input-matrix"></div>
            </div>
            
            <div class="conv-arrow">⊛</div>
            
            <div class="text-center">
              <h4 class="text-ann" style="font-size: 1.4em; margin-bottom: 15px;">Kernel (3×3)</h4>
              <div class="matrix matrix-3x3" id="kernel-matrix"></div>
              <div class="btn-group mt-20">
                <button class="btn" onclick="changeKernel('edge')">Edge</button>
                <button class="btn" onclick="changeKernel('blur')">Blur</button>
                <button class="btn" onclick="changeKernel('sharpen')">Sharpen</button>
              </div>
            </div>
            
            <div class="conv-arrow">=</div>
            
            <div class="text-center">
              <h4 class="text-highlight" style="font-size: 1.4em; margin-bottom: 15px;">Output (3×3)</h4>
              <div class="matrix matrix-3x3" id="output-matrix"></div>
            </div>
          </div>
          
          <div class="step-controls">
            <button class="btn" onclick="prevConvStep()" id="prev-btn">← Previous</button>
            <span id="step-info" class="text-highlight font-bold" style="font-size: 1.2em;">Step 1 of 9</span>
            <button class="btn" onclick="nextConvStep()" id="next-btn">Next →</button>
            <button class="btn secondary" onclick="autoPlayConv()" id="auto-btn">Auto Play</button>
          </div>
          
          <div class="progress-container">
            <div class="progress-bar">
              <div class="progress-fill" id="conv-progress"></div>
            </div>
          </div>
          
          <div class="step-display" id="calculation-display">
            Click "Next" to see step-by-step calculations
          </div>
        </div>
      </div>

      <!-- Features Tab -->
      <div class="tab-content" id="features">
        <div class="feature-maps">
          <div class="feature-card">
            <div class="feature-title">ANN Input (Flattened)</div>
            <canvas class="feature-canvas" id="annInputLarge" width="112" height="112"></canvas>
            <div style="font-size:0.9rem; color: rgba(30, 41, 59, 0.7); margin-top:10px; font-style: italic;">
              784 pixel values
            </div>
          </div>
          
          <div class="feature-card">
            <div class="feature-title">CNN Conv1 Features</div>
            <canvas class="feature-canvas" id="conv1Features" width="224" height="140"></canvas>
            <div style="font-size:0.9rem; color: rgba(30, 41, 59, 0.7); margin-top:10px; font-style: italic;">
              8 feature maps (28×28)
            </div>
          </div>
          
          <div class="feature-card">
            <div class="feature-title">CNN Conv2 Features</div>
            <canvas class="feature-canvas" id="conv2Features" width="224" height="140"></canvas>
            <div style="font-size:0.9rem; color: rgba(30, 41, 59, 0.7); margin-top:10px; font-style: italic;">
              16 feature maps (14×14)
            </div>
          </div>
          
          <div class="feature-card">
            <div class="feature-title">Final Features</div>
            <canvas class="feature-canvas" id="finalFeatures" width="224" height="140"></canvas>
            <div style="font-size:0.9rem; color: rgba(30, 41, 59, 0.7); margin-top:10px; font-style: italic;">
              16 feature maps (7×7)
            </div>
          </div>
        </div>
        
        <div class="math-section">
          <div class="math-title">Receptive Field Growth</div>
          <div class="formula">
            RF_layer = RF_prev + (Kernel_size - 1) × Stride_accumulated<br><br>
            <span class="text-cnn">Layer 1:</span> 1×1 → 3×3 pixels<br>
            <span class="text-cnn">Layer 2:</span> 3×3 → 4×4 pixels (after pooling)<br>
            <span class="text-cnn">Layer 3:</span> 4×4 → 8×8 pixels<br>
            <span style="color: var(--bg-primary);">Final:</span> 8×8 → <strong>16×16 pixels</strong>
          </div>
        </div>
      </div>

      <!-- Comparison Tab -->
      <div class="tab-content" id="comparison">
        <div class="metrics-grid">
          <div class="metric-card">
            <div class="metric-label">ANN Parameters</div>
            <div class="metric-value" id="annParamsComp">50,890</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">CNN Parameters</div>
            <div class="metric-value" id="cnnParamsComp">9,098</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Parameter Reduction</div>
            <div class="metric-value" id="paramReduction">82%</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Memory Efficiency</div>
            <div class="metric-value" id="memoryEff">~5x Better</div>
          </div>
        </div>
        
        <div class="architecture-grid">
          <div class="highlight-box">
            <h3 style="color: var(--bg-primary); margin-bottom: 15px;">Why ANNs Struggle with Images</h3>
            <div style="line-height: 1.8; font-size: 1.1em;">
              ❌ <strong>No Spatial Structure:</strong> Treats images as flat vectors<br>
              ❌ <strong>Too Many Parameters:</strong> 784×64 = 50,240 weights in first layer<br>
              ❌ <strong>Position Dependent:</strong> Moving digit changes all connections<br>
              ❌ <strong>No Translation Invariance:</strong> Same digit in different positions = different patterns<br>
              ❌ <strong>Overfitting Prone:</strong> High parameter count leads to memorization
            </div>
          </div>
          
          <div class="accent-box">
            <h3 style="color: var(--bg-primary); margin-bottom: 15px;">Why CNNs Excel at Images</h3>
            <div style="line-height: 1.8; font-size: 1.1em;">
              ✅ <strong>Parameter Sharing:</strong> Same 3×3 filter used everywhere<br>
              ✅ <strong>Spatial Awareness:</strong> Preserves 2D structure<br>
              ✅ <strong>Translation Invariant:</strong> Detects edges/shapes anywhere<br>
              ✅ <strong>Hierarchical Learning:</strong> Edges → Shapes → Objects<br>
              ✅ <strong>Efficient:</strong> 82% fewer parameters for same task
            </div>
          </div>
        </div>
        
        <div class="math-section">
          <div class="math-title">Mathematical Comparison</div>
          <div class="formula">
            <strong style="color: var(--ann-primary);">ANN Computation:</strong><br>
            Dense Layer: h = ReLU(Wx + b)<br>
            Complexity: O(input_size × output_size)<br>
            First Layer: 784 × 64 = 50,176 multiplications<br><br>
            
            <strong style="color: var(--cnn-primary);">CNN Computation:</strong><br>
            Convolution: Output[i,j] = Σ Input[i+m,j+n] × Kernel[m,n]<br>
            Complexity: O(output_size × kernel_size²)<br>
            First Layer: 28×28 × 3×3 = 7,056 multiplications<br><br>
            
            <span style="color: var(--bg-primary); background: var(--accent-teal); padding: 8px; border-radius: 6px; font-weight: bold;">CNN is ~7x more computationally efficient!</span>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* ========= Utility Functions ========= */
const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));
function softmax(arr) {
  const m = Math.max(...arr);
  const ex = arr.map(v => Math.exp(v - m));
  const s = ex.reduce((p, c) => p + c, 0);
  return ex.map(v => v / s);
}
function cosine(a, b) {
  let s = 0, na = 0, nb = 0;
  for (let i = 0; i < a.length; i++) {
    s += a[i] * b[i];
    na += a[i] * a[i];
    nb += b[i] * b[i];
  }
  if (na === 0 || nb === 0) return 0;
  return s / Math.sqrt(na * nb);
}
function seededRandom(seed) {
  let x = seed | 0 || 123456789;
  return function() {
    x ^= x << 13; x ^= x >>> 17; x ^= x << 5;
    return ((x < 0 ? ~x + 1 : x) % 100000) / 100000;
  }
}
function randn(rng) {
  let u = 0, v = 0;
  while (u === 0) u = rng();
  while (v === 0) v = rng();
  return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
}

/* ========= Drawing Interface ========= */
const draw = document.getElementById('draw');
const mini = document.getElementById('mini');
const dctx = draw.getContext('2d');
const mctx = mini.getContext('2d');
dctx.fillStyle = "#000";
dctx.fillRect(0, 0, 224, 224);

let drawing = false, erasing = false, brush = 18, last = null, undoStack = [];
function pushUndo() {
  undoStack.push(dctx.getImageData(0, 0, 224, 224));
  if (undoStack.length > 8) undoStack.shift();
}

function drawDot(x, y, erase = false) {
  dctx.globalCompositeOperation = erase ? 'destination-out' : 'source-over';
  dctx.beginPath();
  dctx.arc(x, y, brush / 2, 0, Math.PI * 2);
  dctx.fillStyle = erase ? "rgba(0,0,0,1)" : "#fff";
  dctx.fill();
  dctx.globalCompositeOperation = 'source-over';
}

function drawLine(a, b, erase = false) {
  dctx.globalCompositeOperation = erase ? 'destination-out' : 'source-over';
  dctx.lineCap = 'round';
  dctx.lineJoin = 'round';
  dctx.strokeStyle = erase ? "rgba(0,0,0,1)" : "#fff";
  dctx.lineWidth = brush;
  dctx.beginPath();
  dctx.moveTo(a.x, a.y);
  dctx.lineTo(b.x, b.y);
  dctx.stroke();
  dctx.globalCompositeOperation = 'source-over';
}

function getPos(e) {
  const rect = draw.getBoundingClientRect();
  const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
  const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
  return { x, y };
}

draw.addEventListener('mousedown', e => {
  pushUndo();
  drawing = true;
  last = getPos(e);
  drawDot(last.x, last.y, erasing);
});
draw.addEventListener('mousemove', e => {
  if (!drawing) return;
  const p = getPos(e);
  drawLine(last, p, erasing);
  last = p;
});
window.addEventListener('mouseup', () => drawing = false);
draw.addEventListener('touchstart', e => {
  e.preventDefault();
  pushUndo();
  drawing = true;
  last = getPos(e);
  drawDot(last.x, last.y, erasing);
}, { passive: false });
draw.addEventListener('touchmove', e => {
  e.preventDefault();
  if (!drawing) return;
  const p = getPos(e);
  drawLine(last, p, erasing);
  last = p;
}, { passive: false });
draw.addEventListener('touchend', () => drawing = false);

document.getElementById('clearBtn').onclick = () => {
  dctx.clearRect(0, 0, 224, 224);
  dctx.fillStyle = "#000";
  dctx.fillRect(0, 0, 224, 224);
  renderMini();
};
document.getElementById('undoBtn').onclick = () => {
  const prev = undoStack.pop();
  if (prev) dctx.putImageData(prev, 0, 0);
  renderMini();
};
document.getElementById('invertBtn').onclick = () => {
  const img = dctx.getImageData(0, 0, 224, 224);
  for (let i = 0; i < img.data.length; i += 4) {
    img.data[i] = 255 - img.data[i];
    img.data[i + 1] = 255 - img.data[i + 1];
    img.data[i + 2] = 255 - img.data[i + 2];
  }
  dctx.putImageData(img, 0, 0);
  renderMini();
};

const brushRange = document.getElementById('brushRange');
const brushSizeLabel = document.getElementById('brushSizeLabel');
brushRange.oninput = (e) => {
  brush = +e.target.value;
  brushSizeLabel.textContent = brush;
};
document.getElementById('eraserToggle').onchange = (e) => {
  erasing = e.target.checked;
};

function renderMini() {
  const off = document.createElement('canvas');
  off.width = 28;
  off.height = 28;
  const octx = off.getContext('2d');
  octx.drawImage(draw, 0, 0, 28, 28);
  const img = octx.getImageData(0, 0, 28, 28);
  const out = mctx.createImageData(28, 28);
  for (let i = 0; i < img.data.length; i += 4) {
    const v = img.data[i];
    out.data[i] = out.data[i + 1] = out.data[i + 2] = v;
    out.data[i + 3] = 255;
  }
  mctx.putImageData(out, 0, 0);
}

renderMini();
document.getElementById('processBtn').onclick = () => {
  renderMini();
  runModels();
};

document.querySelectorAll('button[data-digit]').forEach(btn => {
  btn.onclick = () => {
    const n = btn.getAttribute('data-digit');
    dctx.fillStyle = "#000";
    dctx.fillRect(0, 0, 224, 224);
    dctx.fillStyle = "#fff";
    dctx.textAlign = "center";
    dctx.textBaseline = "middle";
    dctx.font = "bold 200px Georgia, serif";
    dctx.fillText(n, 112, 120);
    renderMini();
    runModels();
  };
});

function get28() {
  const img = mctx.getImageData(0, 0, 28, 28).data;
  const a = new Float32Array(28 * 28);
  for (let i = 0, j = 0; i < img.length; i += 4, j++) {
    a[j] = img[i] / 255;
  }
  return a;
}

function put28(a) {
  const img = mctx.createImageData(28, 28);
  for (let i = 0; i < 28 * 28; i++) {
    const v = clamp(Math.round(a[i] * 255), 0, 255);
    img.data[i * 4] = v;
    img.data[i * 4 + 1] = v;
    img.data[i * 4 + 2] = v;
    img.data[i * 4 + 3] = 255;
  }
  mctx.putImageData(img, 0, 0);
}

function shift28(a, dx, dy) {
  const b = new Float32Array(28 * 28);
  for (let y = 0; y < 28; y++) {
    for (let x = 0; x < 28; x++) {
      const nx = x - dx, ny = y - dy;
      if (nx >= 0 && nx < 28 && ny >= 0 && ny < 28) {
        b[y * 28 + x] = a[ny * 28 + nx];
      } else b[y * 28 + x] = 0;
    }
  }
  return b;
}

document.getElementById('shiftRight').onclick = () => {
  const a = get28();
  const s = shift28(a, 1, 0);
  put28(s);
  runModels(a, s);
};
document.getElementById('shiftDown').onclick = () => {
  const a = get28();
  const s = shift28(a, 0, 1);
  put28(s);
  runModels(a, s);
};

/* ========= Neural Networks ========= */
const annHiddenSize = 64;
const rng = seededRandom(42);
const W1 = new Float32Array(784 * annHiddenSize);
const b1 = new Float32Array(annHiddenSize);
const W2 = new Float32Array(annHiddenSize * 10);
const b2 = new Float32Array(10);
for (let i = 0; i < W1.length; i++) W1[i] = randn(rng) * 0.15;
for (let i = 0; i < annHiddenSize; i++) b1[i] = randn(rng) * 0.01;
for (let i = 0; i < W2.length; i++) W2[i] = randn(rng) * 0.15;
for (let i = 0; i < 10; i++) b2[i] = randn(rng) * 0.01;

function annForward(x) {
  const h = new Float32Array(annHiddenSize);
  for (let j = 0; j < annHiddenSize; j++) {
    let s = b1[j];
    const off = j * 784;
    for (let i = 0; i < 784; i++) s += W1[off + i] * x[i];
    h[j] = Math.max(0, s);
  }
  const y = new Float32Array(10);
  for (let k = 0; k < 10; k++) {
    let s = b2[k];
    for (let j = 0; j < annHiddenSize; j++) s += W2[k * annHiddenSize + j] * h[j];
    y[k] = s;
  }
  return { h, y: softmax(Array.from(y)) };
}

/* CNN Implementation */
function conv2dSame(x, W, B, H, Wd, Cin, Cout, k = 3) {
  const pad = Math.floor(k / 2);
  const out = new Array(Cout).fill(0).map(() => new Float32Array(H * Wd));
  for (let co = 0; co < Cout; co++) {
    const ymap = out[co];
    for (let y = 0; y < H; y++) {
      for (let x0 = 0; x0 < Wd; x0++) {
        let s = B[co];
        for (let ky = 0; ky < k; ky++) {
          for (let kx = 0; kx < k; kx++) {
            const iy = y + ky - pad, ix = x0 + kx - pad;
            if (iy < 0 || iy >= H || ix < 0 || ix >= Wd) continue;
            for (let ci = 0; ci < Cin; ci++) {
              const w = W[(((co * Cin) + ci) * k + ky) * k + kx];
              s += w * x[ci][iy * Wd + ix];
            }
          }
        }
        ymap[y * Wd + x0] = Math.max(0, s);
      }
    }
  }
  return out;
}

function maxPool2(xMaps, H, Wd, size = 2, stride = 2) {
  const outH = Math.floor((H - size) / stride) + 1;
  const outW = Math.floor((Wd - size) / stride) + 1;
  const out = xMaps.map(m => {
    const y = new Float32Array(outH * outW);
    for (let oy = 0; oy < outH; oy++) {
      for (let ox = 0; ox < outW; ox++) {
        let mv = -1e9;
        for (let ky = 0; ky < size; ky++) {
          for (let kx = 0; kx < size; kx++) {
            const iy = oy * stride + ky, ix = ox * stride + kx;
            mv = Math.max(mv, m[iy * Wd + ix]);
          }
        }
        y[oy * outW + ox] = mv;
      }
    }
    return y;
  });
  return { maps: out, H: outH, W: outW };
}

function flattenMaps(maps) {
  const n = maps.length, sz = maps[0].length;
  const v = new Float32Array(n * sz);
  for (let i = 0; i < n; i++) v.set(maps[i], i * sz);
  return v;
}

const conv1Out = 8, conv2Out = 16, k = 3;
const rng2 = seededRandom(7);
function initConvWeights(cin, cout) {
  const W = new Float32Array(k * k * cin * cout);
  const B = new Float32Array(cout);
  const scale = Math.sqrt(2 / (k * k * cin));
  for (let i = 0; i < W.length; i++) W[i] = randn(rng2) * scale;
  for (let i = 0; i < cout; i++) B[i] = 0;
  return { W, B };
}
const C1 = initConvWeights(1, conv1Out);
const C2 = initConvWeights(conv1Out, conv2Out);
const fcIn = 7 * 7 * conv2Out;
const Wd = new Float32Array(fcIn * 10), bd = new Float32Array(10);
const scaleD = Math.sqrt(2 / fcIn);
for (let i = 0; i < Wd.length; i++) Wd[i] = randn(rng2) * scaleD;
for (let i = 0; i < 10; i++) bd[i] = 0;

function cnnForward(x28) {
  const X0 = [Float32Array.from(x28)];
  const conv1 = conv2dSame(X0, C1.W, C1.B, 28, 28, 1, conv1Out, 3);
  const p1 = maxPool2(conv1, 28, 28, 2, 2);
  const conv2 = conv2dSame(p1.maps, C2.W, C2.B, p1.H, p1.W, conv1Out, conv2Out, 3);
  const p2 = maxPool2(conv2, 14, 14, 2, 2);
  const flat = flattenMaps(p2.maps);
  const logits = new Float32Array(10);
  for (let k = 0; k < 10; k++) {
    let s = bd[k];
    const off = k * fcIn;
    for (let i = 0; i < fcIn; i++) s += Wd[off + i] * flat[i];
    logits[k] = s;
  }
  return { conv1, p1, conv2, p2, y: softmax(Array.from(logits)) };
}

/* ========= Visualization Functions ========= */
function drawAnnVisuals(x, h, yprob) {
  // Input visualization
  const c1 = document.getElementById('annInput');
  if (c1) {
    const a1 = c1.getContext('2d');
    a1.clearRect(0, 0, c1.width, c1.height);
    const gradient = a1.createLinearGradient(0, 0, c1.width, 0);
    gradient.addColorStop(0, '#EA580C');
    gradient.addColorStop(1, '#f97316');
    a1.fillStyle = gradient;
    a1.fillRect(0, 0, c1.width * Math.random() * 0.8 + 0.2, c1.height);
  }

  // Hidden layer visualization
  const c2 = document.getElementById('annHidden');
  if (c2) {
    const a2 = c2.getContext('2d');
    a2.clearRect(0, 0, c2.width, c2.height);
    const cols = 8, rows = 4, cellW = c2.width / cols, cellH = c2.height / rows;
    for (let i = 0; i < 32; i++) {
      const r = Math.floor(i / cols), c = i % cols;
      const x0 = c * cellW, y0 = r * cellH;
      const v = h[i] || 0;
      const intensity = Math.max(0, Math.min(1, v / 2));
      a2.fillStyle = `rgba(234, 88, 12, ${intensity})`;
      a2.fillRect(x0, y0, cellW - 1, cellH - 1);
    }
  }

  // Output visualization
  drawBars('annLogits', yprob);
}

function drawGridOfMaps(canvasId, maps, H, Wd) {
  const cvs = document.getElementById(canvasId);
  if (!cvs) return;
  const ctx = cvs.getContext('2d');
  ctx.clearRect(0, 0, cvs.width, cvs.height);
  
  const n = Math.min(maps.length, 4);
  const cellW = cvs.width / n;
  for (let i = 0; i < n; i++) {
    const x0 = i * cellW;
    let min = 1e9, max = -1e9;
    const m = maps[i];
    for (let k = 0; k < m.length; k++) {
      if (m[k] < min) min = m[k];
      if (m[k] > max) max = m[k];
    }
    const rng = (max - min) || 1;
    
    for (let y = 0; y < H; y++) {
      for (let x = 0; x < Wd; x++) {
        const v = Math.round(255 * (m[y * Wd + x] - min) / rng);
        ctx.fillStyle = `rgba(5, 150, 105, ${v / 255 * 0.8 + 0.2})`;
        ctx.fillRect(x0 + x * (cellW / Wd), y * (cvs.height / H), cellW / Wd, cvs.height / H);
      }
    }
  }
}

function drawBars(canvasId, probs) {
  const cvs = document.getElementById(canvasId);
  if (!cvs) return;
  const ctx = cvs.getContext('2d');
  ctx.clearRect(0, 0, cvs.width, cvs.height);
  const bw = cvs.width / 10;
  for (let i = 0; i < 10; i++) {
    const h = probs[i] * cvs.height;
    const gradient = ctx.createLinearGradient(0, cvs.height - h, 0, cvs.height);
    gradient.addColorStop(0, '#059669');
    gradient.addColorStop(1, '#10b981');
    ctx.fillStyle = gradient;
    ctx.fillRect(i * bw, cvs.height - h, bw - 2, h);
  }
}

/* ========= Interactive Math Demos ========= */
let currentConvStep = 0;
let totalConvSteps = 9;
let convAutoInterval;

function initializeConvDemo() {
  const inputMatrix = document.getElementById('input-matrix');
  if (!inputMatrix) return;
  
  const inputValues = [
    [1, 0, 1, 0, 1],
    [0, 1, 0, 1, 0],
    [1, 0, 2, 0, 1],
    [0, 1, 0, 1, 0],
    [1, 0, 1, 0, 1]
  ];

  inputMatrix.innerHTML = '';
  for (let i = 0; i < 5; i++) {
    for (let j = 0; j < 5; j++) {
      const cell = document.createElement('div');
      cell.className = 'matrix-cell input-cell';
      cell.textContent = inputValues[i][j];
      cell.id = `input-${i}-${j}`;
      inputMatrix.appendChild(cell);
    }
  }
  changeKernel('edge');
  updateConvOutput();
}

function changeKernel(type) {
  const kernelMatrix = document.getElementById('kernel-matrix');
  if (!kernelMatrix) return;
  
  let kernelValues;
  switch (type) {
    case 'edge':
      kernelValues = [[-1, -1, -1], [-1, 8, -1], [-1, -1, -1]];
      break;
    case 'blur':
      kernelValues = [[1/9, 1/9, 1/9], [1/9, 1/9, 1/9], [1/9, 1/9, 1/9]];
      break;
    case 'sharpen':
      kernelValues = [[0, -1, 0], [-1, 5, -1], [0, -1, 0]];
      break;
  }

  kernelMatrix.innerHTML = '';
  for (let i = 0; i < 3; i++) {
    for (let j = 0; j < 3; j++) {
      const cell = document.createElement('div');
      cell.className = 'matrix-cell kernel-cell';
      cell.textContent = typeof kernelValues[i][j] === 'number' ? 
        (kernelValues[i][j] < 1 ? kernelValues[i][j].toFixed(2) : kernelValues[i][j]) : 
        kernelValues[i][j];
      cell.id = `kernel-${i}-${j}`;
      kernelMatrix.appendChild(cell);
    }
  }
  updateConvOutput();
}

function updateConvOutput() {
  const outputMatrix = document.getElementById('output-matrix');
  if (!outputMatrix) return;
  
  outputMatrix.innerHTML = '';
  const inputValues = [
    [1, 0, 1, 0, 1],
    [0, 1, 0, 1, 0],
    [1, 0, 2, 0, 1],
    [0, 1, 0, 1, 0],
    [1, 0, 1, 0, 1]
  ];
  const kernelValues = [[-1, -1, -1], [-1, 8, -1], [-1, -1, -1]];

  for (let i = 0; i < 3; i++) {
    for (let j = 0; j < 3; j++) {
      let sum = 0;
      for (let ki = 0; ki < 3; ki++) {
        for (let kj = 0; kj < 3; kj++) {
          sum += inputValues[i + ki][j + kj] * kernelValues[ki][kj];
        }
      }
      
      const cell = document.createElement('div');
      cell.className = 'matrix-cell output-cell';
      cell.textContent = sum;
      cell.id = `output-${i}-${j}`;
      outputMatrix.appendChild(cell);
    }
  }
}

function nextConvStep() {
  if (currentConvStep < totalConvSteps - 1) {
    currentConvStep++;
    updateConvStep();
  }
}

function prevConvStep() {
  if (currentConvStep > 0) {
    currentConvStep--;
    updateConvStep();
  }
}

function updateConvStep() {
  document.querySelectorAll('.matrix-cell').forEach(cell => {
    cell.classList.remove('highlighted');
  });

  const row = Math.floor(currentConvStep / 3);
  const col = currentConvStep % 3;

  for (let i = 0; i < 3; i++) {
    for (let j = 0; j < 3; j++) {
      const inputCell = document.getElementById(`input-${row + i}-${col + j}`);
      if (inputCell) inputCell.classList.add('highlighted');
    }
  }

  const outputCell = document.getElementById(`output-${row}-${col}`);
  if (outputCell) outputCell.classList.add('highlighted');

  const stepInfo = document.getElementById('step-info');
  if (stepInfo) stepInfo.textContent = `Step ${currentConvStep + 1} of ${totalConvSteps}`;
  
  const progress = ((currentConvStep + 1) / totalConvSteps) * 100;
  const progressEl = document.getElementById('conv-progress');
  if (progressEl) progressEl.style.width = `${progress}%`;

  const prevBtn = document.getElementById('prev-btn');
  const nextBtn = document.getElementById('next-btn');
  if (prevBtn) prevBtn.disabled = currentConvStep === 0;
  if (nextBtn) nextBtn.disabled = currentConvStep === totalConvSteps - 1;

  showConvCalculation(row, col);
}

function showConvCalculation(row, col) {
  const display = document.getElementById('calculation-display');
  if (!display) return;
  
  const inputValues = [
    [1, 0, 1, 0, 1],
    [0, 1, 0, 1, 0],
    [1, 0, 2, 0, 1],
    [0, 1, 0, 1, 0],
    [1, 0, 1, 0, 1]
  ];
  const kernelValues = [[-1, -1, -1], [-1, 8, -1], [-1, -1, -1]];

  let calculation = `Position (${row}, ${col}): `;
  let sum = 0;
  let terms = [];

  for (let i = 0; i < 3; i++) {
    for (let j = 0; j < 3; j++) {
      const inputVal = inputValues[row + i][col + j];
      const kernelVal = kernelValues[i][j];
      const product = inputVal * kernelVal;
      sum += product;
      terms.push(`${inputVal}×${kernelVal}`);
    }
  }

  display.innerHTML = `
    <strong>${calculation}</strong><br>
    ${terms.join(' + ')} = <strong>${sum}</strong>
  `;
}

function autoPlayConv() {
  const btn = document.getElementById('auto-btn');
  if (!btn) return;
  
  if (convAutoInterval) {
    clearInterval(convAutoInterval);
    convAutoInterval = null;
    btn.textContent = 'Auto Play';
  } else {
    btn.textContent = 'Stop';
    convAutoInterval = setInterval(() => {
      if (currentConvStep < totalConvSteps - 1) {
        nextConvStep();
      } else {
        currentConvStep = -1;
        nextConvStep();
      }
    }, 1000);
  }
}

/* ========= Tabs ========= */
document.querySelectorAll('.tab').forEach(t => {
  t.onclick = () => {
    document.querySelectorAll('.tab').forEach(e => e.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(s => s.classList.remove('active'));
    t.classList.add('active');
    document.getElementById(t.dataset.section).classList.add('active');
  };
});

/* ========= Metrics Calculation ========= */
function calcAnnParams() {
  return (784 + 1) * annHiddenSize + (annHiddenSize + 1) * 10;
}
function calcCnnParams() {
  const c1 = (k * k * 1 + 1) * conv1Out;
  const c2 = (k * k * conv1Out + 1) * conv2Out;
  const d = (7 * 7 * conv2Out + 1) * 10;
  return c1 + c2 + d;
}

function fmt(num) {
  if (num > 1e6) return (num / 1e6).toFixed(1) + "M";
  if (num > 1e3) return (num / 1e3).toFixed(1) + "k";
  return num.toString();
}

function setText(id, val) {
  const el = document.getElementById(id);
  if (el) el.textContent = val;
}

function setBar(id, val) {
  const el = document.getElementById(id);
  if (el) el.style.width = (val * 100).toFixed(0) + "%";
}

function runModels(orig28 = null, shifted28 = null) {
  const x = orig28 || get28();
  
  // ANN
  const ann = annForward(x);
  drawAnnVisuals(x, ann.h, ann.y);

  // CNN
  const cnn = cnnForward(x);
  drawGridOfMaps('conv1Grid', cnn.conv1, 28, 28);
  drawGridOfMaps('pool1Grid', cnn.p1.maps, cnn.p1.H, cnn.p1.W);
  drawGridOfMaps('conv2Grid', cnn.conv2, 14, 14);
  drawGridOfMaps('pool2Grid', cnn.p2.maps, cnn.p2.H, cnn.p2.W);
  drawBars('cnnLogits', cnn.y);

  // Detailed feature maps
  drawGridOfMaps('conv1Features', cnn.conv1, 28, 28);
  drawGridOfMaps('conv2Features', cnn.conv2, 14, 14);
  drawGridOfMaps('finalFeatures', cnn.p2.maps, cnn.p2.H, cnn.p2.W);

  // Metrics
  const Pann = calcAnnParams(), Pcnn = calcCnnParams();
  setText('annParams', fmt(Pann));
  setText('cnnParams', fmt(Pcnn));
  setText('annParamsComp', fmt(Pann));
  setText('cnnParamsComp', fmt(Pcnn));
  setText('paramReduction', Math.round((1 - Pcnn / Pann) * 100) + '%');

  // Stability test
  const xShift = shifted28 || shift28(x, 1, 0);
  const annCos = cosine(x, xShift);
  const cnnFeat0 = flattenMaps(cnn.p2.maps);
  const cnnShift = cnnForward(xShift);
  const cnnFeat1 = flattenMaps(cnnShift.p2.maps);
  const cnnCos = cosine(cnnFeat0, cnnFeat1);

  setText('annStabVal', annCos.toFixed(3));
  setText('cnnStabVal', cnnCos.toFixed(3));
  setBar('annStab', annCos);
  setBar('cnnStab', cnnCos);
}

/* ========= Initialization ========= */
document.addEventListener('DOMContentLoaded', function() {
  initializeConvDemo();
  updateConvStep();
  runModels();
});

// Live mini preview update
let miniTimer = null;
['mouseup', 'mousemove', 'touchend', 'touchmove'].forEach(ev => {
  draw.addEventListener(ev, () => {
    clearTimeout(miniTimer);
    miniTimer = setTimeout(() => { renderMini(); }, 60);
  }, { passive: true });
});
</script>
</body>
</html>
